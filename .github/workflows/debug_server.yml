name: Debug Server (Manual)

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=============================================="
            echo "ğŸ” 1. Docker å®¹å™¨çŠ¶æ€ (Docker PS)"
            echo "=============================================="
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "=============================================="
            echo "ğŸ“ 2. Backend æ—¥å¿— (Startup Logs - Head 50)"
            echo "=============================================="
            # æŸ¥çœ‹æœ€å¼€å§‹å¯åŠ¨çš„æ—¥å¿—ï¼Œçœ‹æœ‰æ²¡æœ‰ immediate crash
            docker logs points_backend 2>&1 | head -n 50
            
            echo ""
            echo "=============================================="
            echo "ğŸ“ 3. Backend æ—¥å¿— (Recent Logs - Tail 100)"
            echo "=============================================="
            # æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
            docker logs --tail 100 points_backend 2>&1
            
            echo ""
            echo "=============================================="
            echo "ğŸ“ 4. Nginx é”™è¯¯æ—¥å¿— (Tail 50)"
            echo "=============================================="
            docker exec points_nginx tail -n 50 /var/log/nginx/error.log || echo "âŒ æ— æ³•è¯»å– Nginx errorlog"
            
            echo ""
            echo "=============================================="
            echo "ğŸŒ 5. ç½‘ç»œè¿é€šæ€§æµ‹è¯• (Nginx -> Backend)"
            echo "=============================================="
            # æµ‹è¯• DNS è§£æ
            echo ">> Testing Ping 'points_backend' from Nginx container..."
            docker exec points_nginx ping -c 2 points_backend || echo "âŒ Ping points_backend FAILED"
            
            echo ""
            echo ">> Testing Ping 'backend' (Service Name) from Nginx container..."
            docker exec points_nginx ping -c 2 backend || echo "âŒ Ping backend FAILED"
            
            echo ""
            echo ">> Testing HTTP Connection (Curl) from Nginx container..."
            # ä½¿ç”¨ curl æµ‹è¯•ç«¯å£æ˜¯å¦é€š
            docker exec points_nginx curl -v --connect-timeout 5 http://points_backend:8000/docs || echo "âŒ Curl failed"
            
            echo ""
            echo "=============================================="
            echo "ğŸ—„ï¸ 6. æ•°æ®åº“è¿æ¥æµ‹è¯• (Backend -> DB)"
            echo "=============================================="
            # ç®€å•æ£€æŸ¥åç«¯èƒ½å¦ ping é€šæ•°æ®åº“
            docker exec points_backend ping -c 2 points_mysql || echo "âŒ Ping points_mysql FAILED"
            
            echo "=============================================="
            echo "âœ… diagnostic finished"
