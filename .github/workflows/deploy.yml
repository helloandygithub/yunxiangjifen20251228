name: Deploy to Tencent Cloud

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. 确定项目目录 (根据探测结果)
            # 优先尝试 /home/root/points-platform (通常也是 /root/points-platform)
            # 其次尝试 /home/ubuntu/points-platform
            PROJECT_DIR="/root/points-platform"
            if [ ! -d "$PROJECT_DIR" ]; then
              PROJECT_DIR="/home/ubuntu/points-platform"
            fi
            
            # 如果目录还是不存在，尝试从已知路径推断 (兜底)
            if [ ! -d "$PROJECT_DIR" ]; then
               PROJECT_DIR=$(find /home -name "points-platform" -type d -maxdepth 3 2>/dev/null | head -n 1)
            fi
            
            if [ -z "$PROJECT_DIR" ]; then
              echo "❌ 无法找到项目目录 points-platform，请手动确认服务器路径！"
              exit 1
            fi
            
            echo "✅ 锁定部署目录: $PROJECT_DIR"
            cd "$PROJECT_DIR" || exit 1

            # 2. 强制同步代码 (将当前目录变为 Git 仓库并覆盖)
            # 注意：这不会删除 .env 和 uploads，因为它们在 .gitignore 里
            if [ ! -d ".git" ]; then
              echo "⚙️ 初始化 Git 仓库..."
              git init
            fi

            # 无论如何，强制配置 remote 为 HTTPS 格式，并在 URL 中嵌入 Token (如果有)
            # 注意：为了安全，尽量使用 HTTPS 并且依赖 GitHub Actions 的 SSH Agent Forwarding? 
            # 不，最简单的是解决 SSH Host Key 问题。
            
            # 方案：手动添加 GitHub 的指纹到 known_hosts
            mkdir -p ~/.ssh
            ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts 2>/dev/null
            
            # 使用 SSH 协议 (前提是服务器已经配置了 Deploy Key，或者是 Public 仓库)
            # 如果服务器本身没有权限拉取代码，我们需要把 Action 里的 SSH Key 转发过去
            # 但 Action 里的 Key 是用来连服务器的，不一定是用来连 GitHub 的。
            # 让用户去配 Deploy Key 太麻烦。
            
            # 终极方案：使用 HTTPS 克隆公共仓库 (如果仓库是 Public)
            # 或者使用 embedded token (如果是 Private)
            # 这里假设您的仓库是 Public 的，或者您愿意稍后把它设为 Public
            # 或者，我们尝试使用 SSH Agent Forwarding (虽然 ssh-action 支持，但不一定好用)
            
            # 让我们试试 HTTPS 方式 (不带 Token，如果仓库是 Public 的话能通)
            # 如果仓库是 Private，您需要把 GITHUB_TOKEN 传进来
            
            git remote remove origin 2>/dev/null || true
            git remote add origin https://github.com/helloandygithub/yunxiangjifen20251228.git
            
            echo "⬇️ 拉取最新代码..."
            git fetch --all
            git reset --hard origin/main
            
            # 执行部署脚本
            # 赋予脚本执行权限
            chmod +x scripts/deploy.sh
            # 运行部署脚本
            ./scripts/deploy.sh
